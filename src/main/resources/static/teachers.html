<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Escolar - Professores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">üè´ Sistema Escolar</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Alunos (Tela 1)</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="teachers.html">Professores (Tela 2)</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gest√£o de Grade Hor√°ria</h2>
        <div>
            <button onclick="abrirModalCadastrarProf()" class="btn btn-outline-info me-2">
                üë®‚Äçüè´ Cadastrar Professor
            </button>
            <button onclick="abrirModalCriar()" class="btn btn-primary">
                ‚ûï Novo Agendamento
            </button>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Filtrar por S√©rie</label>
                    <select id="filtroSerie" class="form-select" onchange="aplicarFiltros()">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Filtrar por Turma</label>
                    <select id="filtroTurma" class="form-select" onchange="aplicarFiltros()">
                        <option value="">Todas</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-secondary">
                <tr>
                    <th># Reg.</th>
                    <th>Professor (ID)</th>
                    <th>Mat√©ria</th>
                    <th>S√©rie (Degree)</th>
                    <th>Turma (Class)</th>
                    <th class="text-end">A√ß√µes</th>
                </tr>
                </thead>
                <tbody id="tabelaCorpo">
                </tbody>
            </table>
        </div>
    </div>

</div>

<div class="modal fade" id="modalCriar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Relacionamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>Professor</label>
                    <select id="newTeacher" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label>Mat√©ria</label>
                    <select id="newMatter" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label>Turma (Define a S√©rie automaticamente)</label>
                    <select id="newClass" class="form-select"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button onclick="salvarAgendamento()" type="button" class="btn btn-success">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCadastrarProf" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Cadastrar Novo Professor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nome do Professor</label>
                    <input type="text" class="form-control" id="inputNomeProf" placeholder="Ex: Professor Girafales">
                </div>
                <div class="mb-3">
                    <label class="form-label">Especialidade / Mat√©ria Principal</label>
                    <input type="text" class="form-control" id="inputMateriaProf" placeholder="Ex: Matem√°tica">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button onclick="salvarNovoProfessor()" type="button" class="btn btn-primary">Salvar Professor</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAlunos" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Alunos desta S√©rie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul id="listaAlunosModal" class="list-group">
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let listaAgendamentos = [];
    let listaAlunos = [];
    let listaSeries = [];
    let modalCriarInstance;
    let modalAlunosInstance;
    let modalCadastrarProfInstance;

    window.onload = async () => {
        const elModalCriar = document.getElementById('modalCriar');
        const elModalAlunos = document.getElementById('modalAlunos');
        const elModalProf = document.getElementById('modalCadastrarProf');

        if(elModalCriar) modalCriarInstance = new bootstrap.Modal(elModalCriar);
        if(elModalAlunos) modalAlunosInstance = new bootstrap.Modal(elModalAlunos);
        if(elModalProf) modalCadastrarProfInstance = new bootstrap.Modal(elModalProf);

        await carregarCombos();
        await carregarAlunos();
        await carregarTabela();
    };

    async function carregarCombos() {
        const [resProf, resMat, resTurmas, resSeries] = await Promise.all([
            fetch('/teachers/all'),
            fetch('/matters/all'),
            fetch('/class/all'),
            fetch('/degrees/all')
        ]);

        const professores = await resProf.json();
        const materias = await resMat.json();
        const turmas = await resTurmas.json();
        listaSeries = await resSeries.json();

        preencherSelect('newTeacher', professores);
        preencherSelect('newMatter', materias);
        preencherSelect('newClass', turmas);

        preencherSelect('filtroTurma', turmas);
        preencherSelect('filtroSerie', listaSeries);
    }

    function preencherSelect(id, dados) {
        const select = document.getElementById(id);
        if(!id.includes('filtro')) select.innerHTML = '';

        dados.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.name}</option>`;
        });
    }

    async function carregarTabela() {
        const res = await fetch('/schedule/all');
        if(res.ok) {
            listaAgendamentos = await res.json();
            desenharTabela(listaAgendamentos);
        }
    }

    async function carregarAlunos() {
        const res = await fetch('/students/all');
        if(res.ok) listaAlunos = await res.json();
    }

    function desenharTabela(dados) {
        const tbody = document.getElementById('tabelaCorpo');
        let htmlBuffer = '';

        dados.forEach(item => {
            const teacherObj = item.teacher;
            const profNome = teacherObj ? `<strong>${teacherObj.name}</strong> <small class="text-muted">(ID: ${teacherObj.id})</small>` : 'Sem Prof.';

            const materia = item.matter ? item.matter.name : 'Sem Mat√©ria';
            const turma = item.classEntity ? item.classEntity.name : 'Sem Turma';

            let serieNome = '-';
            let degreeId = null;

            if (item.classEntity && item.classEntity.degreeId) {
                degreeId = item.classEntity.degreeId;
                const serieObj = listaSeries.find(s => s.id === degreeId);
                if(serieObj) serieNome = serieObj.name;
            }

            htmlBuffer += `
            <tr>
                <td><span class="text-muted">#${item.id}</span></td>
                <td>${profNome}</td>
                <td>${materia}</td>
                <td><span class="badge bg-info text-dark">${serieNome}</span></td>
                <td>${turma}</td>
                <td class="text-end">
                    <button onclick="verAlunosDaSerie(${degreeId}, '${serieNome}')" class="btn btn-sm btn-outline-primary me-2">
                        üë• Ver Alunos
                    </button>
                    <button onclick="deletarAgendamento(${item.id})" class="btn btn-sm btn-outline-danger">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = htmlBuffer;
    }

    function aplicarFiltros() {
        const idSerie = document.getElementById('filtroSerie').value;
        const idTurma = document.getElementById('filtroTurma').value;

        const filtrados = listaAgendamentos.filter(item => {
            let passouSerie = true;
            let passouTurma = true;

            if(idSerie && item.classEntity) {
                if(item.classEntity.degreeId != idSerie) passouSerie = false;
            }

            if(idTurma && item.classEntity) {
                if(item.classEntity.id != idTurma) passouTurma = false;
            }

            return passouSerie && passouTurma;
        });

        desenharTabela(filtrados);
    }

    function abrirModalCriar() {
        if(modalCriarInstance) modalCriarInstance.show();
    }

    function abrirModalCadastrarProf() {
        if(modalCadastrarProfInstance) modalCadastrarProfInstance.show();
    }

    async function salvarAgendamento() {
        const teacherId = document.getElementById('newTeacher').value;
        const matterId = document.getElementById('newMatter').value;
        const classId = document.getElementById('newClass').value;

        const payload = {
            teacher: { id: teacherId },
            matter: { id: matterId },
            classEntity: { id: classId }
        };

        const res = await fetch('/schedule/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            alert("Agendamento criado!");
            modalCriarInstance.hide();
            carregarTabela();
        } else {
            alert("Erro ao salvar. Verifique o console.");
        }
    }

    async function salvarNovoProfessor() {
        const nome = document.getElementById('inputNomeProf').value;
        const materia = document.getElementById('inputMateriaProf').value;

        if(!nome || !materia) {
            alert("Preencha nome e mat√©ria!");
            return;
        }

        const payload = {
            name: nome,
            subject: materia
        };

        const res = await fetch('/teachers/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            alert("Professor cadastrado com sucesso!");
            modalCadastrarProfInstance.hide();
            await carregarCombos();

            document.getElementById('inputNomeProf').value = "";
            document.getElementById('inputMateriaProf').value = "";
        } else {
            alert("Erro ao salvar professor. Verifique o console.");
        }
    }

    async function deletarAgendamento(id) {
        if(confirm("Tem certeza que quer remover este agendamento?")) {
            const res = await fetch(`/schedule/delete/${id}`, { method: 'DELETE' });

            if(res.ok) {
                await carregarTabela();
            } else {
                alert("Erro ao excluir. Verifique o console.");
            }
        }
    }

    function verAlunosDaSerie(degreeId, nomeSerie) {
        const listaUl = document.getElementById('listaAlunosModal');
        listaUl.innerHTML = '';
        document.querySelector('#modalAlunos .modal-title').innerText = `Alunos de: ${nomeSerie}`;

        const alunosFiltrados = listaAlunos.filter(aluno =>
            aluno.classEntity && aluno.classEntity.degreeId == degreeId
        );

        if(alunosFiltrados.length === 0) {
            listaUl.innerHTML = '<li class="list-group-item text-muted">Nenhum aluno encontrado nesta s√©rie.</li>';
        } else {
            alunosFiltrados.forEach(aluno => {
                listaUl.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${aluno.name}
                            <span class="badge bg-secondary">${aluno.classEntity.name}</span>
                        </li>
                    `;
            });
        }

        if(modalAlunosInstance) modalAlunosInstance.show();
    }
</script>
</body>
</html>